{% load static %}
{% load tz %}
{% localtime on %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="{% static 'base/style.css' %}">

<h1>Hello {{ request.user }}</h1>

<form action="{% url 'logout' %}" method="post">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>

<input class="search-user-input" id="search-user-input" type="search" placeholder="Search" aria-label="Search" name="search" >
<button class="search-user-button" id="search-user-button" type="submit">Search</button>

<div class="users">
    <ul id="users-list"></ul>
    <span style="visibility: hidden">No Users!</span>
</div>

<body>
    <div class="container">
        <div class="sidebar">
            <ul class="chat-list" id="chat-list">
                {% if user_chats.count > 0 %}
                        {% for chat in user_chats %}
                                <li chat-id="{{ chat.id }}" class="chat" style="text-wrap: wrap">
                                    <span>
                                        {% if chat.target.username == request.user.username %}
                                        {{ chat.belong }} {% else %} {{ chat.target }}
                                        {% endif %}
                                    </span>
                                    <span chat-id="{{ chat.id }}" class="chat-notification" style="display: none">0</span>
                                </li>
                        {% endfor %}
                {% else %}
                    <li id="no-chats-banner">No chats are available.</li>
                {% endif %}
            </ul>
        </div>
        <div class="chat-container">
            <div class="chat-header" id="chat-header"></div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                {% csrf_token %}
                <label for="message-input"></label>
                <input type="text" id="message-input" placeholder="Type your message here..." disabled>
                <button id="send-button" disabled>Send</button>
            </div>
        </div>
    </div>
    <script>
        let textInput = document.getElementById("message-input");
        let sendButton = document.getElementById("send-button");
        let activeRoomId = null;
        const chatSockets = {};
        let chatBox;

        {% for message in chat_messages %}
            {% if message.hasRead == False and message.source.id != request.user.id %}
                chatBox = document.querySelector(".chat-notification[chat-id='{{ message.chat.id }}']");
                if (chatBox.style.display === "none") {
                    chatBox.style.display = "";
                }
                chatBox.textContent = parseInt(chatBox.textContent) + 1;
            {% endif %}
        {% endfor %}

        const userSocket = createUserSocket("{{ request.user.username }}")
        {% for chat in user_chats %}
            createChatSocket({{chat.id}});
        {% endfor %}

        function createUserSocket(username) {
            const userSocket = new WebSocket(
                `ws://${window.location.host}/base/user/${username}/`
            );

            userSocket.onmessage = function(e) {
                if("{{ request.user.username }}" !== JSON.parse(e["data"])["source_username"]) {
                    let chat_id = JSON.parse(e['data'])['chat_id'];
                    let newChat = document.querySelector(".chat[chat-id=${JSON.parse(e['data'])['chat_id']}]");
                    if (newChat == null) {
                        let chatList = document.getElementById("chat-list");
                        let chatElement = document.createElement("li")
                        chatElement.setAttribute("chat-id", JSON.parse(e["data"])["chat_id"]);
                        chatElement.classList.add("chat");
                        chatElement.textContent = JSON.parse(e["data"])["source_username"];
                        chatList.insertBefore(chatElement, chatList.firstChild);

                        createChatSocket(JSON.parse(e["data"])["chat_id"]);

                        let text = document.querySelector("#no-chats-banner");
                        if(text) {
                            text.remove();
                        }
                    }
                }
            };

            userSocket.onclose = function(e) {
                console.error(`Chat socket for ${username} closed unexpectedly`);
            };

            return userSocket;
        }

        function createChatSocket(chat_id) {
            const chatSocket = new WebSocket(
                `ws://${window.location.host}/base/chat/${chat_id}/`
            );

            chatSocket.chat_id = chat_id;

            chatSocket.onmessage = function(e) {
                loadChat(chat_id);
            };

            chatSocket.onclose = function(e) {
                console.error(`Chat socket for ${chat_id} closed unexpectedly`);
            };

            chatSockets[chat_id] = chatSocket;
        }

        function sendMessage(socket, message, source) {
            waitForSocketConnection(socket, function() {
                socket.send(JSON.stringify({
                'message': message,
                'source_id': source,
                }));
            });
        }

        function sendChatCreationMessage(socket, chat_id, source) {
            waitForSocketConnection(socket, function() {
                socket.send(JSON.stringify({
                'chat_id': chat_id,
                'source_username': source,
                }));
            });
        }

        function waitForSocketConnection(socket, callback) {
            setTimeout(
                function() {
                    if(socket.readyState === 1) {
                        if(callback !== undefined) {
                            callback();
                        }
                        return;
                    } else {
                        waitForSocketConnection(socket, callback);
                    }
                }, 5)
        }

        //makes the ajax django auth compatible
        $.ajaxSetup({
        beforeSend: function(xhr, settings) {
             function getCookie(name) {
                 let cookieValue = null;
                 if (document.cookie && document.cookie !== '') {
                     let cookies = document.cookie.split(';');
                     for (let i = 0; i < cookies.length; i++) {
                         let cookie = jQuery.trim(cookies[i]);

                         if (cookie.substring(0, name.length + 1) === (name + '=')) {
                             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                             break;
                         }
                     }
                 }
                 return cookieValue;
             }
             if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {

                 xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
             }
         }, async: false,
        });

        function getDateElement(date) {
            let now = new Date();
            let weekBefore = new Date();
            let dateElement = document.createElement("div");
            dateElement.classList.add("messageDate");

            weekBefore.setDate(weekBefore.getDate() - 7)
            weekBefore.setHours(0,0,0);
            if(date.valueOf() > weekBefore.valueOf()) {
                let weekDayIndex = date.getDay();
                let daysOfTheWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                let dayOfTheWeek = daysOfTheWeek[weekDayIndex];

                if (now.getDay() === weekDayIndex) {
                    dayOfTheWeek = "Today";
                }
                else if (weekDayIndex === 6 && now.getDay() === 0 || weekDayIndex === now.getDay() - 1) {
                    dayOfTheWeek = "Yesterday";
                }

                dateElement.textContent = dayOfTheWeek;
            } else {
                dateElement.textContent = date.toLocaleString('us-EN').substring(0,11);
            }

            return dateElement;
        }

        function loadChat(chatId) {
            let chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            let messageElement;
            let messageText;
            let messageTime;
            let dateElement;

            $.ajax({
                type: "GET",
                url: "{% url 'base:get_messages' %}",
                data: {
                    "chat": chatId,
                },
                dataType: "json",
                success: function (data) {
                    let messages=data["messages"];
                    let now = new Date();
                    let flag = true;
                    let currentDateIndicator = new Date(messages[0].date);

                    for (let i = 0; i < messages.length; i++) {
                        let date = new Date(messages[i].date);

                        if (currentDateIndicator.getDay() !== date.getDay() || currentDateIndicator.getMonth() !== date.getMonth() || currentDateIndicator.getFullYear() !== date.getFullYear()) {
                            flag = true;
                        }
                        if (flag) {
                            dateElement = getDateElement(date);
                            chatMessages.appendChild(dateElement);

                            flag = false;
                            currentDateIndicator = date;
                        }
                        currentDateIndicator = date;

                        messageElement = document.createElement('div');
                        messageText = document.createElement('p');
                        messageTime = document.createElement('span');

                        messageElement.classList.add('message', messages[i].source_id === {{ request.user.id }} ? 'sent' : 'received');
                        messageElement.setAttribute('hasRead', messages[i]["hasRead"]);
                        messageElement.setAttribute('hasReached', messages[i]["hasReached"]);
                        messageText.classList.add('messageText');
                        messageTime.classList.add('messageTime');
                        messageText.textContent = messages[i].message;

                        messageTime.textContent = date.toLocaleTimeString('en-GB', { hour: "numeric", minute: "numeric"});
                        messageElement.appendChild(messageText);
                        messageElement.appendChild(messageTime);
                        messageElement.setAttribute("message-id", messages[i].id);
                        chatMessages.appendChild(messageElement);
                    }
                },
                failure: function () {
                    alert("failure")
                }
            });

            let chatHeader = document.getElementById('chat-header');
            chatHeader.textContent = document.querySelector('.chat-list li[chat-id="' + chatId + '"]').firstElementChild.textContent;
            let firstUnread = document.querySelector('.message.received[hasRead="false"]');
            if(firstUnread != null) {
                chatMessages.scrollTo(0, firstUnread.scrollTop);
            } else {
                chatMessages.scrollTo(0, chatMessages.scrollHeight);
            }
        }

        function clearChat() {
            let chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';

            let chatHeader = document.getElementById('chat-header');
            chatHeader.innerHTML = '';
        }

        document.getElementById('chat-list').addEventListener('click', function(event) {
            if(event.target.id !== "no-chats-banner" && event.target.tagName === 'LI') {
                let activeChat = document.querySelector('.chat-list li.active');

                if (event.target.classList.contains("active")) {
                    activeChat.classList.remove('active');

                    textInput.setAttribute("disabled", true);
                    sendButton.setAttribute("disabled", true);
                    clearChat();
                }
                else {
                    textInput.removeAttribute("disabled");
                    sendButton.removeAttribute("disabled");

                    event.target.classList.add("active");
                    loadChat(event.target.getAttribute('chat-id'));
                }
                if(activeChat) {
                    activeChat.classList.remove("active");
                }
            }
        });

        document.getElementById('chat-messages').addEventListener('scrollend', function(event) {
            let messages = document.querySelectorAll(".message.received[hasread='false']");
            let notification = document.querySelector(".chat.active .chat-notification");

            messages.forEach(message => {
                if (message.offsetTop - event.target.offsetTop < event.target.scrollTop + event.target.clientHeight - 40) {
                    message.setAttribute("hasread", 'true');
                    notification.textContent = parseInt(notification.textContent) - 1;
                    if(parseInt(notification.textContent) === 0) {
                        notification.style.display = "none";
                    }

                    $.ajax({
                    type: "POST",
                    url: "{% url 'base:read_message' %}",
                    data: {
                        "id": message.getAttribute("message-id")
                    },
                    dataType: "json",
                    success: function (data) {

                    },
                    });
                }
            });
        });

        document.getElementById('send-button').addEventListener('click', function() {
            let messageInput = document.getElementById('message-input');
            let messageText = messageInput.value.trim();
            let chatMessages = document.getElementById('chat-messages');
            let activeChat = document.querySelector('.chat-list li.active');
            let activeChatId = activeChat.getAttribute('chat-id');

            if (messageText !== '') {
                if(activeChat.hasAttribute("new")) {
                    $.ajax({
                    type: "POST",
                    url: "{% url 'base:create_chat' %}",
                    data: {
                        "target": activeChat.textContent,
                    },
                    dataType: "json",
                    success: function (data) {
                        activeChat.removeAttribute("new");
                        activeChat.setAttribute("chat-id", data["chat_id"]);
                        activeChatId = activeChat.getAttribute('chat-id');
                        createChatSocket(data["chat_id"]);
                        let recipientSocket = createUserSocket(activeChat.textContent);

                        sendChatCreationMessage(recipientSocket, data["chat_id"], "{{ request.user.username }}");
                        sendMessage(chatSockets[activeChatId], messageText, {{ request.user.id }});

                        let messageElement = document.createElement('div');
                        messageElement.classList.add('message', 'sent');
                        messageElement.textContent = messageText;

                        chatMessages.appendChild(messageElement);
                        chatMessages.scrollTo({top: chatMessages.scrollHeight, behavior: "smooth"})
                        messageInput.value = '';
                        messageInput.focus();
                    },
                    });
                } else {
                    chatSockets[activeChatId].send(JSON.stringify({
                    'message': messageText,
                    'source_id': {{ request.user.id }},
                    }));

                    let messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'sent');
                    messageElement.textContent = messageText;

                    chatMessages.appendChild(messageElement);
                    messageInput.value = '';
                    messageInput.focus();
                }
            }
        });

        document.getElementById('message-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('send-button').click();
            }
        });

        document.getElementById('search-user-button').addEventListener('click', function() {
            const input = document.getElementById('search-user-input');

            if(input.value !== '') {
                $.ajax({
                    type: "GET",
                    url: "{% url 'base:search_user' %}",
                    data: {
                        "username": input.value,
                    },
                    dataType: "json",
                    success: function (data) {
                        let users = data["users"];
                        let userElement;
                        let userName;
                        let userList = document.getElementById('users-list');
                        userList.innerHTML = '';
                        let text = document.querySelector(".users > span");

                        if(users.length === 0){
                            text.style.visibility = "visible";
                        } else {
                            text.style.visibility = "hidden";

                            for(let i=0; i<users.length; i++) {
                            userElement = document.createElement('li');
                            userElement.classList.add('user');

                            userList.appendChild(userElement);

                            userName = document.createElement('a');
                            userName.textContent = users[i].username;
                            userName.classList.add("username")
                            userName.href = "#";
                            userElement.appendChild(userName);
                            }
                        }

                        const userNames = document.querySelectorAll('.username');
                        userNames.forEach(el => el.addEventListener('click', () => {
                            let username = el.textContent;
                            const chats = document.querySelectorAll('.chat');
                            let flag = true;
                            if(chats.length !== 0) {
                                chats.forEach(element => {
                                    if (username === element.textContent) {
                                        flag = false;
                                        element.click();
                                        userList.innerHTML = '';
                                    }
                                })
                                if (flag) {
                                    let chatList = document.getElementById("chat-list");

                                    let chatElement = document.createElement('li');
                                    chatElement.setAttribute("chat-id", data["chat_id"]);
                                    chatElement.setAttribute("new", "true");
                                    chatElement.innerText = username;

                                    let activeChat = document.querySelector('.chat-list li.active');
                                    if (activeChat) {
                                        activeChat.classList.remove('active');
                                    }
                                    chatElement.classList.add("chat", "active");
                                    chatList.appendChild(chatElement);

                                    loadChat(data["chat_id"]);
                                    userList.innerHTML = '';
                                }
                            } else {
                                let chatList = document.getElementById("chat-list");

                                let chatElement = document.createElement('li');
                                chatElement.setAttribute("chat-id", data["chat_id"]);
                                chatElement.setAttribute("new", "true");
                                chatElement.innerText = username;

                                let activeChat = document.querySelector('.chat-list li.active');
                                if (activeChat) {
                                    activeChat.classList.remove('active');
                                }
                                chatElement.classList.add("chat", "active");
                                chatList.appendChild(chatElement);

                                loadChat(data["chat_id"]);
                                textInput.removeAttribute("disabled");
                                sendButton.removeAttribute("disabled");
                                userList.innerHTML = '';

                                let text = document.querySelector("#no-chats-banner");
                                text.remove();
                            }
                        }));
                    },
                    failure: function () {

                    }
                });
            }
        });

        document.getElementById('search-user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('search-user-button').click();
            }
        });
    </script>
</body>
{% endlocaltime %}