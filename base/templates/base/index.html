{% load static %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="{% static 'base/style.css' %}">

<h1>Hello {{ request.user }}</h1>

<form action="{% url 'logout' %}" method="post">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>

<input class="search-user-input" id="search-user-input" type="search" placeholder="Search" aria-label="Search" name="search" >
<button class="search-user-button" id="search-user-button" type="submit">Search</button>

<div class="users">
    <ul id="users-list"></ul>
    <span style="display: none">No Users!</span>
</div>

<body>
    <div class="container">
        <div class="sidebar">
            <ul class="chat-list" id="chat-list">
                {% if user_chats.count > 0 %}
                        {% for chat in user_chats %}
                        <li data-chat="{{ chat.id }}" class="chat">{{chat}}</li>
                        {% endfor %}
                {% else %}
                    <li>No chats are available.</li>
                {% endif %}
            </ul>
        </div>
        <div class="chat-container">
            <div class="chat-header" id="chat-header"></div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                {% csrf_token %}
                <input type="text" id="message-input" placeholder="Type your message here...">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
    <script>
        $.ajaxSetup({
        beforeSend: function(xhr, settings) {
             function getCookie(name) {
                 var cookieValue = null;
                 if (document.cookie && document.cookie != '') {
                     var cookies = document.cookie.split(';');
                     for (var i = 0; i < cookies.length; i++) {
                         var cookie = jQuery.trim(cookies[i]);
                         // Does this cookie string begin with the name we want?
                         if (cookie.substring(0, name.length + 1) == (name + '=')) {
                             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                             break;
                         }
                     }
                 }
                 return cookieValue;
             }
             if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                 // Only send the token to relative URLs i.e. locally.
                 xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
             }
         }
        });

        function loadChat(chatId) {
            var chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            var messageElement;

            $.ajax({
                type: "GET",
                url: "{% url 'base:get_messages' %}",
                data: {
                    "chat": chatId,
                },
                dataType: "json",
                success: function (data) {
                    var messages=data["messages"];

                    for(var i=0; i<messages.length; i++) {
                        messageElement = document.createElement('div');
                        messageElement.classList.add('message', messages[i].source_id === {{ request.user.id }} ? 'sent' : 'received');
                        messageElement.textContent = messages[i].message;
                        chatMessages.appendChild(messageElement);
                    }
                },
                failure: function () {
                    alert("failure")
                }
            });

            var chatHeader = document.getElementById('chat-header');
            chatHeader.textContent = document.querySelector('.chat-list li[data-chat="' + chatId + '"]').textContent;
        }

        document.getElementById('chat-list').addEventListener('click', function(event) {
            if (event.target.tagName === 'LI') {
                var activeChat = document.querySelector('.chat-list li.active');
                if (activeChat) {
                    activeChat.classList.remove('active');
                }
                event.target.classList.add('active');
                loadChat(event.target.getAttribute('data-chat'));
            }
        });

        document.getElementById('send-button').addEventListener('click', function() {
            console.log("clicked");
            var messageInput = document.getElementById('message-input');
            var messageText = messageInput.value.trim();
            var chatMessages = document.getElementById('chat-messages');

            if (messageText !== '') {
                var activeChatId = document.querySelector('.chat-list li.active').getAttribute('data-chat');

                $.ajax({
                    type: "POST",
                    url: "{% url 'base:send_message' %}",
                    data: {
                        "chat_id": activeChatId,
                        "message": messageText,
                        "source_id": {{ request.user.id }},
                    },
                    dataType: "json",
                    success: function (data) {
                    },
                    failure: function () {

                    }
                });

                var messageElement = document.createElement('div');
                messageElement.classList.add('message', 'sent');
                messageElement.textContent = messageText;

                chatMessages.appendChild(messageElement);
                messageInput.value = '';
                messageInput.focus();
            }
        });

        document.getElementById('message-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('send-button').click();
            }
        });

        document.getElementById('search-user-button').addEventListener('click', function() {
            const input = document.getElementById('search-user-input');

            if(input.text !== '') {
                $.ajax({
                    type: "GET",
                    url: "{% url 'base:search_user' %}",
                    data: {
                        "username": input.value,
                    },
                    dataType: "json",
                    success: function (data) {
                        users = data["users"];
                        var userElement;
                        var userName;
                        let userList = document.getElementById('users-list');
                        userList.innerHTML = '';

                        for(var i=0; i<users.length; i++) {
                            userElement = document.createElement('li');
                            userElement.classList.add('user');

                            userList.appendChild(userElement);

                            userName = document.createElement('a');
                            userName.textContent = users[i].username;
                            userName.classList.add("username")
                            userName.href = "#";
                            userElement.appendChild(userName);
                        }

                        const userNames = document.querySelectorAll('.username');
                        userNames.forEach(el => el.addEventListener('click', event => {
                            let username = el.textContent;
                            const chats = document.querySelectorAll('.chat');
                            let flag = true;
                            if(chats.length !== 0) {
                                chats.forEach(element => {
                                    if (username === element.textContent) {
                                        flag = false;
                                        element.click();
                                        userList.innerHTML = '';
                                    }
                                })
                                if (flag) {
                                    $.ajax({
                                        type: "POST",
                                        url: "{% url 'base:create_chat' %}",
                                        data: {
                                            "target": username,
                                        },
                                        dataType: "json",
                                        success: function (data) {
                                            var chatList = document.getElementById("chat-list");

                                            var chatElement = document.createElement('li');
                                            chatElement.setAttribute("data-chat", data["chat_id"]);
                                            chatElement.innerText = username;
                                            chatElement.classList.add("chat", "active");
                                            chatList.appendChild(chatElement);

                                            loadChat(data["chat_id"]);
                                        },
                                        failure: function () {

                                        },
                                        complete: function () {
                                            userList.innerHTML = '';
                                        }
                                    });
                                }
                            } else {
                                console.log("ZORT");
                                $.ajax({
                                        type: "POST",
                                        url: "{% url 'base:create_chat' %}",
                                        data: {
                                            "target": username,
                                        },
                                        dataType: "json",
                                        success: function (data) {
                                            var chatList = document.getElementById("chat-list");

                                            var chatElement = document.createElement('li');
                                            chatElement.setAttribute("data-chat", data["chat_id"]);
                                            chatElement.innerText = username;
                                            chatElement.classList.add("chat", "active");
                                            chatList.appendChild(chatElement);

                                            loadChat(data["chat_id"]);

                                        },
                                        failure: function () {

                                        },
                                        complete: function () {
                                            userList.innerHTML = '';
                                        }
                                    });
                            }

                        }));
                    },
                    failure: function () {

                    }
                });
            }
        });

        document.getElementById('search-user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('search-user-button').click();
            }
        });
    </script>
</body>