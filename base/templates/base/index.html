{% load static %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="{% static 'base/style.css' %}">

<body>
    <div class="sidebar">
        <div id="logout-button"><img src="{% static 'base/logout.png' %}" class="sidebar-icon" alt="Logout"></div>
        <form action="{% url 'logout' %}" method="post" id="logout-form">
            {% csrf_token %}
        </form>
    </div>
    <div class="new-chat-overlay" id="new-chat-overlay" style="display: none">
        <h2 style="margin: 10px 0">New chat</h2>
        <input class="search-user-input" id="search-user-input" type="search" placeholder="Search" aria-label="Search" name="search" >
        <button class="search-user-button" id="search-user-button" type="submit" hidden="hidden">Search</button>

        <div class="users">
            <ul id="users-list"></ul>
            <span style="visibility: hidden">No Users!</span>
        </div>
    </div>
    <div class="container">
        <div class="chat-list-container">
            <div class="chat-list-header">
                <h2 style="float: left; margin-left: 5px">Chats</h2>
                <div class="new-chat-button" id="new-chat-button"><img src="{% static 'base/new_chat.png' %}" id="new-chat-icon" alt="Create new chat"></div>
            </div>

            <ul class="chat-list" id="chat-list">
                {% if user_chats.count > 0 %}
                        {% for chat in user_chats %}
                                <li chat-id="{{ chat.id }}" class="chat" style="text-wrap: wrap">
                                    <span>{% if chat.target.username == request.user.username %}
                                        {{chat.belong|cut:" "}} {% else %} {{chat.target|cut:" " }} {% endif %}
                                    </span>
                                    <span chat-id="{{ chat.id }}" class="chat-notification" style="display: none">0</span>
                                </li>
                        {% endfor %}
                {% else %}
                    <li id="no-chats-banner">No chats are available.</li>
                {% endif %}
            </ul>
        </div>
        <div class="chat-container" style="background-image: url({% static 'base/background-default.png' %})">
            <div class="chat-header" id="chat-header"></div>
            <div class="chat-messages" id="chat-messages"></div>

            <div class="go-bottom-button" id="go-bottom-button">
                <span id="go-bottom-notification">0</span>
                <img src="{% static 'base/go-bottom.png' %}" alt="Go down" id="go-bottom-icon" class="sidebar-icon">
            </div>
            <div class="chat-input">
                {% csrf_token %}
                <emoji-picker style="display: none" id="emoji-picker"></emoji-picker>
                <div class="emoji-picker-button" style="display: block" id="emoji-picker-button" disabled="true">
                    <img src="{% static 'base/emoji-icon.png' %}" alt="Go down" id="emoji-icon" class="sidebar-icon">
                </div>

                <label for="message-input"></label>
                <input type="text" id="message-input" placeholder="Type your message here..." disabled>
                <button id="send-button" disabled>Send</button>
            </div>
        </div>
    </div>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script>
        //makes the ajax django auth compatible by appending the django csrf token to ajax header
        $.ajaxSetup({
        beforeSend: function(xhr, settings) {
             function getCookie(name) {
                 let cookieValue = null;

                 if (document.cookie && document.cookie !== '') {
                     let cookies = document.cookie.split(';');
                     for (let i = 0; i < cookies.length; i++) {
                         let cookie = jQuery.trim(cookies[i]);

                         if (cookie.substring(0, name.length + 1) === (name + '=')) {
                             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                             break;
                         }
                     }
                 }
                 return cookieValue;
             }
             if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                 xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
             }
         }, async: false,
        });

        const messageInput = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const newChatOverlay = document.getElementById("new-chat-overlay");
        const chatMessages = document.getElementById('chat-messages');
        const goBottomButton = document.getElementById("go-bottom-button");
        const goBottomNotification = document.getElementById("go-bottom-notification");
        const emojiPickerButton = document.getElementById("emoji-picker-button");
        const emojiPicker = document.querySelector("emoji-picker");
        const chatSockets = {};

        const userSocket = createUserSocket("{{ request.user.username }}")
        {% for chat in user_chats %}
            createChatSocket({{chat.id}});
        {% endfor %}

        let notification;
        {% for message in chat_messages %}
            {% if message.source.id != request.user.id %}
                {% if message.hasRead == False %}
                    notification = document.querySelector(".chat-notification[chat-id='{{ message.chat.id }}']");
                    if (notification.style.display === "none") {
                        notification.style.display = "";
                    }
                    notification.textContent = parseInt(notification.textContent) + 1 + "";
                {% endif %}

                {% if message.hasReached == False %}
                    sendMessage(chatSockets[{{ message.chat_id }}], type="message_reached", id= {{ message.id }});
                {% endif %}
            {% endif %}
        {% endfor %}

        function createUserSocket(username) {
            const userSocket = new WebSocket(
                `ws://${window.location.host}/base/user/${username}/`
            );

            userSocket.onmessage = function(e) {
                if ("{{ request.user.username }}" !== JSON.parse(e["data"])["source_username"]) {
                    const chat_id = JSON.parse(e['data'])['chat_id'];
                    const username = JSON.parse(e["data"])["source_username"];
                    const newChat = document.querySelector(".chat[chat-id='${chat_id}']");

                    if (newChat == null) {
                        const chatList = document.getElementById("chat-list");
                        const chatElement = getChatElement(chat_id, username)

                        const notificationElement = chatElement.firstChild.nextSibling;
                        notificationElement.style.display = "";
                        notificationElement.textContent = "1";

                        chatList.insertBefore(chatElement, chatList.firstChild);

                        createChatSocket(chat_id);

                        const noChatsBanner = document.querySelector("#no-chats-banner");
                        if (noChatsBanner) {
                            noChatsBanner.remove();
                        }
                    }
                }
            }

            userSocket.onclose = function(e) {
                console.error('Chat socket for ${username} closed unexpectedly, ${e}');
            };

            return userSocket;
        }

        function createChatSocket(chat_id) {
            const chatSocket = new WebSocket(
                `ws://${window.location.host}/base/chat/${chat_id}/`
            );
            chatSocket.chat_id = chat_id;

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e["data"]);
                const activeChat = document.querySelector('.chat-list li.active');
                const chat_notification = document.querySelector('.chat-notification[chat-id="' + data.chat_id + '"]');

                if(data.type === 'chat_message') {
                    const viewingOlderMessages = chatMessages.scrollTop + chatMessages.clientHeight + 30 < chatMessages.scrollHeight;

                    //if the incoming message's chat is open, show the message
                    if(activeChat != null && parseInt(activeChat.getAttribute("chat-id")) === parseInt(data.chat_id)) {
                        //if this message is the first message of the day, create a "Today" indicator.
                        const todayIndicator = document.querySelector(".messageDate[today='true']");
                        if (todayIndicator == null) {
                            const date = new Date('{% now "l, F j, Y g:i A" %}');
                            const dateElement = getDateElement(date);

                            chatMessages.appendChild(dateElement);
                        }

                        //when user responds someone, remove the "Unread Messages" indicator.
                        const unreadMessagesIndicator = document.getElementById("unread-messages");
                        if(unreadMessagesIndicator != null) {
                            unreadMessagesIndicator.remove();
                        }

                        chatMessages.appendChild(getMessageElement(data));

                        if (viewingOlderMessages && data.source_id !== {{ request.user.id }}) {
                            goBottomNotification.textContent = parseInt(goBottomNotification.textContent) + 1 + "";
                            if(goBottomNotification.style.display === "none") {
                                goBottomNotification.style.display = "block";
                            }
                        } else {
                            chatMessages.scrollTo(0, chatMessages.scrollHeight);
                        }

                        //if there is no scrollbar, trigger the event manually for reading the messages
                        if(chatMessages.scrollHeight === chatMessages.clientHeight) {
                            chatMessages.dispatchEvent(new CustomEvent("scroll"));
                        }
                    } else { //if incoming message's chat is not open, just increase the notification
                        if (chat_notification.style.display === "none") {
                            chat_notification.style.display = ""
                            chat_notification.textContent = "0";
                        }
                        chat_notification.textContent = parseInt(chat_notification.textContent) + 1 + "";
                    }
                } else if (data.type === "message_reached" && activeChat != null) {
                    const message = document.querySelector(".sent[message-id='" + data.message_id + "'] span span");

                    if(message) {
                        message.textContent = " ";
                        message.textContent += "✓✓";
                    }
                }
                else if (data.type === "message_read" && activeChat != null) {
                    const message = document.querySelector(".sent[message-id='" + data.message_id + "'] span span");

                    if(message) {
                        message.classList.add("blue");
                    }
                }

                //if this user is the receiving end, notify the sender that message is reached
                if(data.source_id !== {{ request.user.id }} && data.type === "chat_message") {
                    sendMessage(this, "message_reached", data.message_id);
                }
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket for ${chat_id} closed unexpectedly, ${e}');
            };

            chatSockets[chat_id] = chatSocket;
        }

        function sendMessage(socket, type, id, message) {
            waitForSocketConnection(socket, function() {
                if(type === 'chat_message') {
                    socket.send(JSON.stringify({
                    'message': message,
                    'source_id': id,
                    'type': type,
                }));
                } else {
                    socket.send(JSON.stringify({
                        'message_id': id,
                        'type': type,
                    }));
                }
            });
        }

        function sendChatCreationMessage(socket, chat_id, source) {
            waitForSocketConnection(socket, function() {
                socket.send(JSON.stringify({
                'chat_id': chat_id,
                'source_username': source,
                'type': "chat_creation"
                }));
            });
        }

        function waitForSocketConnection(socket, callback) {
            setTimeout(
                function() {
                    if(socket.readyState === 1) {
                        if(callback !== undefined) {
                            callback();
                        }
                    } else {
                        waitForSocketConnection(socket, callback);
                    }
                }, 5)
        }

        function getDateElement(date) {
            const now = new Date();
            const weekBefore = new Date();
            weekBefore.setDate(weekBefore.getDate() - 6)
            weekBefore.setHours(0,0,0);
            const dateElement = document.createElement("div");
            dateElement.classList.add("messageDate");

            if(date.valueOf() > weekBefore.valueOf()) {
                const daysOfTheWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                const weekDayIndex = date.getDay();
                let dayOfTheWeek = daysOfTheWeek[weekDayIndex];

                if (now.getDay() === weekDayIndex) {
                    dayOfTheWeek = "Today";
                    dateElement.setAttribute("today", "true");
                }
                else if (weekDayIndex === 6 && now.getDay() === 0 || weekDayIndex === now.getDay() - 1) {
                    dayOfTheWeek = "Yesterday";
                }

                dateElement.textContent = dayOfTheWeek;
            } else {
                dateElement.textContent = date.toLocaleString('us-EN').substring(0,11);
            }

            return dateElement;
        }

        function getMessageElement(message) {
            const messageElement = document.createElement('div');
            const messageText = document.createElement('p');
            const messageTime = document.createElement('span');

            messageElement.classList.add('message', message.source_id === {{ request.user.id }} ? 'sent' : 'received');
            messageElement.setAttribute('hasRead', message["hasRead"]);
            messageElement.setAttribute('hasReached', message["hasReached"]);
            messageElement.setAttribute('hasSent', message["hasSent"]);

            messageText.classList.add('messageText');
            messageText.textContent = message.message;

            messageTime.classList.add('messageTime');
            const date = new Date(message.date);
            messageTime.textContent = date.toLocaleTimeString('en-GB', { hour: "numeric", minute: "numeric"});

            messageElement.appendChild(messageText);

            if (message.message_id != null) {
                messageElement.setAttribute("message-id", message.message_id);
            } else {
                messageElement.setAttribute("message-id", message.id);
            }


            if (message.source_id === {{ request.user.id }}) {
                const messageStatus = document.createElement('span');
                messageStatus.classList.add("message-status");
                messageStatus.textContent = " ";

                if (message["hasSent"] === true) {
                    messageStatus.textContent += "✓";
                }
                if (message["hasReached"] === true) {
                    messageStatus.textContent += "✓";
                }
                if (message["hasRead"] === true) {
                    messageStatus.classList.add("blue");
                }
                messageTime.appendChild(messageStatus);
            }

            messageElement.appendChild(messageTime);
            return messageElement;
        }

        function loadChat(chatId) {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            let messageElement;
            let dateElement;

            if (chatId !== "undefined") { //If chat is not newly created
                $.ajax({
                type: "GET",
                url: "{% url 'base:get_messages' %}",
                data: {
                    "chat": chatId,
                },
                dataType: "json",
                success: function (data) {
                    const messages=data["messages"];

                    if(messages.length > 0) {
                        let flag = true;
                        let unread = false;
                        let currentDateIndicator = new Date(messages[0].date);

                        for (let i = 0; i < messages.length; i++) {
                            const date = new Date(messages[i].date);

                            if (currentDateIndicator.getDay() !== date.getDay() || currentDateIndicator.getMonth() !== date.getMonth() || currentDateIndicator.getFullYear() !== date.getFullYear()) {
                                flag = true;
                            }
                            if (flag) {
                                dateElement = getDateElement(date);
                                chatMessages.appendChild(dateElement);

                                flag = false;
                                currentDateIndicator = date;
                            }
                            currentDateIndicator = date;
                            if(messages[i].source_id !== {{ request.user.id }} && messages[i].hasRead === false && !unread) {
                                unread = true;

                                const unreadElement = document.createElement("div");
                                unreadElement.id = "unread-messages";
                                unreadElement.textContent = "↓ Unread Messages ↓";

                                chatMessages.appendChild(unreadElement);
                            }

                            messageElement = getMessageElement(messages[i]);
                            chatMessages.appendChild(messageElement);
                        }
                    }},
                failure: function () {
                    alert("failure");
                }
            });
            }

            chatMessages.dispatchEvent(new CustomEvent("scroll"));

            const chatHeader = document.getElementById('chat-header');
            chatHeader.textContent = document.querySelector('.chat-list li.active').firstElementChild.textContent;
            chatHeader.style.display = "block";

            const firstUnread = document.querySelector('.message.received[hasread="false"]');
            chatMessages.scrollTo({top: chatMessages.scrollHeight, behavior: "smooth"})

            if(firstUnread != null) {
                chatMessages.scrollTo({top: firstUnread.offsetTop - chatMessages.clientHeight, behavior: "instant"});
            } else {
                chatMessages.scrollTo({top : chatMessages.scrollHeight, behavior: "instant"});
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';

            const chatHeader = document.getElementById('chat-header');
            chatHeader.innerHTML = '';
            chatHeader.style.display = "none";
        }

        document.getElementById('chat-list').addEventListener('click', function(event) {
            let target = event.target;

            if(event.target.id !== "no-chats-banner" && $(event.target).parent().id !== "no-chats-banner") {
                if(event.target.tagName.toLowerCase() !== "li") {
                    target = event.target.parentNode;
                } else if (event.target.tagName.toLowerCase() === "span"){
                    target = event.target;
                }

                if(event.target.tagName.toLowerCase() === "li") {
                    const activeChat = document.querySelector('.chat-list li.active');

                    if(emojiPicker.style.display !== "none") {
                        emojiPicker.style.display = "none";
                    }

                    if (target.classList.contains("active")) {
                        activeChat.classList.remove('active');

                        messageInput.setAttribute("disabled", "true");
                        sendButton.setAttribute("disabled", "true");
                        emojiPickerButton.setAttribute("disabled", "true");
                        clearChat();
                    }
                    else {
                        messageInput.removeAttribute("disabled");
                        sendButton.removeAttribute("disabled");
                        emojiPickerButton.removeAttribute("disabled");

                        if(activeChat) {
                            activeChat.classList.remove("active");
                        }
                        target.classList.add("active");

                        loadChat(target.getAttribute('chat-id'));
                    }
                }
            }
        })

        document.getElementById('chat-messages').addEventListener('scroll', function(event) {
            const messages = document.querySelectorAll(".message.received[hasread='false']");
            const notification = document.querySelector(".chat.active .chat-notification");
            const activeChat = document.querySelector('.chat-list li.active');
            if (activeChat != null) {
                const activeChatId = activeChat.getAttribute('chat-id');
            }
            let chatMessages = document.getElementById("chat-messages");

            messages.forEach(message => {
                if (message.offsetTop - event.target.offsetTop < event.target.scrollTop + event.target.clientHeight - message.scrollHeight) {
                    message.setAttribute("hasread", 'true');
                    notification.textContent = parseInt(notification.textContent) - 1 + "";
                    if(parseInt(notification.textContent) === 0) {
                        notification.style.display = "none";
                    }
                    sendMessage(chatSockets[activeChatId], "message_read", message.getAttribute('message-id'));
                }
            });

            if (chatMessages.scrollTop + chatMessages.clientHeight + 30 < chatMessages.scrollHeight) {
                if (goBottomButton.style.display === "none") {
                    goBottomButton.style.display = "block";
                    if (parseInt(goBottomNotification.textContent) > 0) {
                        goBottomNotification.style.display = "block";
                    }
                }
            } else if (goBottomButton.style.display !== "none") {
                goBottomButton.style.display = "none";
                goBottomNotification.style.display = "none";
                goBottomNotification.textContent = 0;
            }
        });

        document.getElementById('send-button').addEventListener('click', function() {
            const messageText = messageInput.value.trim();
            const activeChat = document.querySelector('.chat-list li.active');
            let activeChatId = activeChat.getAttribute('chat-id');
            const notificationElement = document.querySelector('.chat-list li.active .chat-notification')

            if (messageText !== '') {
                if(activeChat.hasAttribute("new")) { //Creating the chat in the database when the creator sending a message
                    $.ajax({
                    type: "POST",
                    url: "{% url 'base:create_chat' %}",
                    data: {
                        "target": activeChat.firstChild.textContent.trim(),
                    },
                    dataType: "json",
                    success: function (data) {
                        activeChat.removeAttribute("new");
                        activeChat.setAttribute("chat-id", data["chat_id"]);

                        notificationElement.setAttribute("chat-id", data["chat_id"]);
                        activeChatId = activeChat.getAttribute('chat-id');

                        createChatSocket(data["chat_id"]);
                        const recipientSocket = createUserSocket(activeChat.firstChild.textContent);

                        sendChatCreationMessage(recipientSocket, data["chat_id"], "{{ request.user.username }}");
                        sendMessage(chatSockets[activeChatId], 'chat_message', {{ request.user.id }}, messageText);

                        messageInput.value = '';
                        messageInput.focus();
                    },
                    });
                } else {
                    sendMessage(chatSockets[activeChatId], 'chat_message', {{ request.user.id }}, messageText);

                    messageInput.value = '';
                    messageInput.focus();
                }
            }
        });

        document.getElementById('message-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('send-button').click();
            }
        });

        document.getElementById('message-input').addEventListener('click', function(event) {
            if(emojiPicker.style.display !== "none") {
                emojiPicker.style.display = "none";
            }
        })

        function getChatElement(chat_id, username) {
            const chatElement = document.createElement('li');
            chatElement.setAttribute("chat-id", chat_id);
            chatElement.setAttribute("new", "true");
            chatElement.style.textWrap = "wrap";
            chatElement.classList.add("chat");

            const usernameElement = document.createElement("span");
            usernameElement.textContent = username;

            const notificationElement = document.createElement("span");
            notificationElement.setAttribute("chat-id", chat_id);
            notificationElement.style.display = "none";
            notificationElement.textContent = "0";
            notificationElement.classList.add("chat-notification");

            chatElement.appendChild(usernameElement);
            chatElement.appendChild(notificationElement);

            return chatElement;
        }

        function enableMessageInput() {
            messageInput.removeAttribute("disabled");
            sendButton.removeAttribute("disabled");
            emojiPickerButton.removeAttribute("disabled");
        }

        document.getElementById('search-user-button').addEventListener('click', function() {
            const input = document.getElementById('search-user-input');

            if(input.value !== '') {
                $.ajax({
                    type: "GET",
                    url: "{% url 'base:search_user' %}",
                    data: {
                        "username": input.value,
                    },
                    dataType: "json",
                    success: function (data) {
                        const users = data["users"];
                        const userList = document.getElementById('users-list');
                        const noUsersText = document.querySelector(".users > span");

                        userList.innerHTML = '';

                        if(users.length === 0){
                            noUsersText.style.visibility = "visible";
                        } else {
                            noUsersText.style.visibility = "hidden";

                            for(let i=0; i<users.length; i++) {
                                const userElement = document.createElement('li');
                                userElement.classList.add('user');
                                userList.appendChild(userElement);

                                const userName = document.createElement('a');
                                userName.textContent = users[i].username;
                                userName.classList.add("username")
                                userName.href = "#";
                                userElement.appendChild(userName);
                            }
                        }

                        //open the chat of the user or create new
                        document.querySelectorAll('.username').forEach(el => el.addEventListener('click', () => {
                            const username = el.textContent;
                            const chats = document.querySelectorAll('.chat');
                            let alreadyChatting = false;

                            if(chats.length === 0) {
                                document.querySelector("#no-chats-banner").remove();
                            }

                            chats.forEach(chat => {
                                if (username.trim() === chat.firstChild.nextSibling.textContent.trim()) { //open the chat if it exists
                                    alreadyChatting = true;
                                    chat.click();
                                    userList.innerHTML = '';
                                    newChatOverlay.style.display = "none";

                                    const button = document.getElementById("new-chat-button");
                                    button.classList.remove("active");
                                    userList.innerHTML = '';
                                    input.value = '';
                                }
                            })
                            if (!alreadyChatting) { //create new chat
                                const chatList = document.getElementById("chat-list");
                                const button = document.getElementById("new-chat-button");

                                button.classList.remove("active");
                                newChatOverlay.style.display = "none";
                                input.value = '';

                                const activeChat = document.querySelector('.chat-list li.active');
                                if (activeChat) {
                                    activeChat.classList.remove('active');
                                }

                                const chatElement = getChatElement(data["chat_id"], username.trim());
                                chatElement.classList.add("active");
                                chatList.appendChild(chatElement);

                                loadChat(data["chat_id"]);

                                enableMessageInput();
                                userList.innerHTML = '';
                            }
                        }));
                    },
                    failure: function () {

                    }
                });
            }
        });

        //searching users with pressing enter
        document.getElementById('search-user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('search-user-button').click();
            }
        });

        document.getElementById('new-chat-button').addEventListener('click', function(event) {
            if (newChatOverlay.style.display === "none") {
                newChatOverlay.style.display = "block";
                this.classList.add("active");
                let input = document.getElementById("search-user-input");
                input.focus();
            } else {
                newChatOverlay.style.display = "none";
                this.classList.remove('active');
            }
        })

        document.getElementById('logout-button').addEventListener('click', function(event) {
            let form = document.getElementById('logout-form');
            form.submit();
        })

        goBottomButton.addEventListener('click', function(event) {
            chatMessages.scrollTo(0, chatMessages.scrollHeight);

            goBottomButton.style.display = "none";
        })

        emojiPickerButton.addEventListener('click', function(event) {
            if (!emojiPickerButton.hasAttribute("disabled")) {
                if (emojiPicker.style.display === "none") {
                    emojiPicker.style.display = "block";
                } else {
                    emojiPicker.style.display = "none";
                }
            }
        })

        emojiPicker.addEventListener('emoji-click', event => messageInput.value = messageInput.value + event["detail"]["unicode"]);
    </script>
</body>
